---
layout: post
title: "Polymorphic Javascript malware"
thumbnail: mosquito-240.jpg
date: 2016-02-18
---

Recently I received two similar e-mails with viruses, both using encoded Javascript. The e-mail described that I received a remittance and that I should open the attachment to claim my money. The attachment was a ZIP file named `WU6533175781.zip`, containing a ZIP file named file.zip, containing a Javascript file named `invoice_Ir1vkp.js`. The file is probably zipped twice to get around some antivirus software. Also, the Javascript is encoded:


    var insensatePtK = decode('"AD4qHg9EOH0qJwgvWw=="');
    var revelryk8e = decode('"Gj4RISoGYgs0AyUXY2Y="');
    …
    if (riledjg) {
        engageegd[toutfVe](wandervwY + Math.pow(2, 19));
    }

As you can see both the variable names and the string literals are encoded. The `decode` function is defined in the same file. It base64-decodes the string and XORs it with a cipher:

    var decode = function (packedText) {
        var cipher ="WmIlf4LSyOmC766Y";
        …
        var text = Base64.decode(packedText);

        var cipherLength = cipher.length;
        var result = "";
        for (var i = 0; i < text.length; i++) {
            result += String.fromCharCode(text.charCodeAt(i) ^ cipher.charCodeAt(i % cipherLength));
        }
        return result;
    };

Now, what is interesting is that the two mails that I received had basically the same code, encoded differently. So the structure and the decode function was the same, but the cipher, the string literals and the variable names differed. I assume this is to make it harder for virus scanners to detect this thing. It is remarkable then that the `decode` function itself is not obfuscated, since that would be an easy marker to recognize this malware.

Because we have the `decode` function it is easy to decode all the strings in the script, and we can rename the variables to see what the code really does:


Apparently it downloads and runs an EXE, supposedly with some CryptoLocker variation.

As you can see it takes extra effort to obfuscate the EXE filename, using 524288 at once place and `Math.pow(2, 19)`, which is also 524288, when actually running the file.
